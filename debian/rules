#!/usr/bin/make -f

include debian/get-orig.rules

build clean install binary-arch binary-indep binary:
	+dh $(opt_no_act) $@

override_dh_auto_clean:
	dh_auto_clean --builddirectory debian/xzdec-build
	dh_auto_clean --builddirectory debian/normal-build
	rm -fr build-aux
	rm -f ABOUT-NLS aclocal.m4 config.h.in configure
	cd po && xargs -d "\n" rm -f < .gitignore
	cd m4 && xargs -d "\n" rm -f < .gitignore
	find . -name Makefile.in -delete

override_dh_auto_configure:
	autoreconf -fi
	dh_auto_configure --builddirectory debian/normal-build -- \
		$(opt_optimize) $(opt_quiet)
	dh_auto_configure --builddirectory debian/xzdec-build -- \
		--disable-shared --disable-nls --disable-encoders \
		--enable-small --disable-threads \
		$(opt_optimize_small) $(opt_quiet)

override_dh_auto_build:
	dh_auto_build --builddirectory debian/normal-build
	cd debian/normal-build && doxygen Doxyfile
	$(MAKE) -C debian/xzdec-build/src/liblzma
	$(MAKE) -C debian/xzdec-build/src/xzdec

override_dh_auto_test:
	$(MAKE) -C debian/normal-build check

override_dh_auto_install:
	dh_auto_install --builddirectory debian/normal-build
	$(MAKE) -C debian/xzdec-build/src/xzdec install \
		DESTDIR=$$(pwd)/debian/tmp

override_dh_installchangelogs:
	dh_installchangelogs debian/changelog.upstream

opt_no_act =
opt_optimize = CFLAGS="-g -O2"
opt_optimize_small = CFLAGS="-g -Os"
opt_quiet =
comma=,
space_sep_build_opts=$(subst $(comma), ,$(DEB_BUILD_OPTIONS))
ifneq (,$(findstring n,$(MAKEFLAGS)))
    opt_no_act = --no-act
endif
ifneq (,$(filter noopt,$(space_sep_build_opts)))
    opt_optimize = --disable-assembler CFLAGS="-g -O0"
    opt_optimize_small = --disable-assembler CFLAGS="-g -O0"
endif
ifndef in_submake
ifneq (,$(filter parallel=%,$(space_sep_build_opts)))
    MAKEFLAGS += -j $(subst parallel=,,$(filter parallel=%,$(space_sep_build_opts)))
endif
endif
ifneq (,$(filter quiet,$(space_sep_build_opts)))
    opt_quiet = --quiet
    MAKEFLAGS += --quiet
endif
in_submake = yes
export in_submake

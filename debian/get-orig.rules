#!/usr/bin/make -f
# Build a tarball with the latest upstream version.
# This is made complicated by the need to choose a nice version number.

get-orig-source:
	mkdir debian/orig-source
	-set -e; cd debian/orig-source; \
		: fetch latest upstream version; \
		git init -q; \
		git fetch -q --tags git://ctrl.tukaani.org/xz.git; \
		git fetch -q git://ctrl.tukaani.org/xz.git master; \
		: determine upstream version number; \
		commit_name=$$(git describe FETCH_HEAD); \
		release=$${commit_name%%-*}; \
		date=$$(date --utc --date="$$( \
			git log -1 --pretty=format:%aD "$$commit_name" \
			)" "+%Y%m%d"); \
		if test "$$commit_name" = "$$release"; \
		then upstream_version=$${commit_name#v}; \
		else upstream_version="$${release#v}+$${date}"; \
		fi; \
		: generate tarball; \
		echo "packaging $$commit_name"; \
		git archive --format=tar "$$commit_name" \
			--prefix="xz-utils-$$upstream_version/" | \
		gzip -9 > "../../xz-utils_$$upstream_version.orig.tar.gz"
	rm -fr debian/orig-source
